# 消息队列

前面说到管道的通信方式是效率低的，因此管道不适合进程间频繁地交换数据。  

对于这个问题，**消息队列**的通信模式就可以解决。比如，A 进程要给 B 进程发送消息，A 进程把数据放在对应的消息队列后就可以正常返回了，B 进程需要的时候再去读取数据就可以了。同理，B 进程要给 A 进程发送消息也是如此。  

再来，**消息队列是保存在内核中的消息链表**，在发送数据时，会分成一个一个独立的数据单元，也就是消息体（数据块），消息体是用户自定义的数据类型，消息的发送方和接收方要约定好消息体的数据类型，所以每个消息体都是固定大小的存储块，不像**管道是无格式的字节流数据**。如果进程从消息队列中读取了消息体，内核就会把这个消息体删除。  

消息队列生命周期随内核，如果没有释放消息队列或者没有关闭操作系统，消息队列会一直存在，而前面提到的匿名管道的生命周期，是随进程的创建而建立，随进程的结束而销毁。  

消息这种模型，两个进程之间的通信就像平时发邮件一样，你来一封，我回一封，可以频繁沟通了。  

但邮件的通信方式存在不足的地方有两点，一是通信不及时，二是附件也有大小限制，这同样也是消息队列通信不足的点。  

**消息队列不适合比较大数据的传输**，因为在内核中每个消息体都有一个最大长度的限制，同时所有队列所包含的全部消息体的总长度也是有上限。在 Linux 内核中，会有两个宏定义 `MSGMAX` 和 `MSGMNB`，它们以字节为单位，分别定义了一条消息的最大长度和一个队列的最大长度。  

**消息队列通信过程中，存在用户态与内核态之间的数据拷贝开销**，因为进程写入数据到内核中的消息队列时，会发生从用户态拷贝数据到内核态的过程，同理另一进程读取内核中的消息数据时，会发生从内核态拷贝数据到用户态的过程。  

我们可以用 `ipcs` 命令来打印进程间通信设施状态，包括消息队列、共享内存和信号量的信息。  

```sh
[work@bogon www]$ ipcs

--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息

------------ 共享内存段 --------------
键        shmid      拥有者  权限     字节     nattch     状态
0x00000000 2          gdm        777        16384      1          目标
0x00000000 5          gdm        777        2129920    2          目标

--------- 信号量数组 -----------
键        semid      拥有者  权限     nsems
```

我们可以看到目前消息队列为空。  

下面我们尝试往消息队列中发送一条数据：    

```php
<?php

// ftok：Convert a pathname and a project identifier to a System V IPC key（把一个路径和标识符转换成 IPC 的 key）
$key = ftok(__FILE__, 'a');
// msg_get_queue：Create or attach to a message queue（根据传入的键创建或返回一个消息队列的引用）
$queue = msg_get_queue($key);

// 往消息队列发送一条消息
msg_send($queue, 2, 'hello');

echo '消息队列发送成功' . PHP_EOL;
```

可以看到多了一个消息队列。  

```sh
[work@bogon www]$ php test.php
消息队列发送成功
[work@bogon www]$ ipcs

--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息
0x6103c315 0          root       666        12           1

------------ 共享内存段 --------------
键        shmid      拥有者  权限     字节     nattch     状态
0x00000000 2          gdm        777        16384      1          目标
0x00000000 5          gdm        777        2129920    2          目标

--------- 信号量数组 -----------
键        semid      拥有者  权限     nsems
```

**我们明明写入的是 hello，应该是 5 个字节，为什么上面显示的是已用 12 个字节？**  

先删除上面的消息队列，`ipcrm -Q 0x6103c315`，然后用 `strace` 命令追踪系统调用。  

```sh
[root@bogon www]# strace -f -s 65535 -o msg.log php test.php
消息队列发送成功
[root@bogon www]# ipcs

--------- 消息队列 -----------
键        msqid      拥有者  权限     已用字节数 消息
0x6103c315 1          root       666        12           1

------------ 共享内存段 --------------
键        shmid      拥有者  权限     字节     nattch     状态
0x00000000 2          gdm        777        16384      1          目标
0x00000000 5          gdm        777        2129920    2          目标

--------- 信号量数组 -----------
键        semid      拥有者  权限     nsems
```

<div align=center><img src="https://raw.githubusercontent.com/duiying/img/master/消息队列系统调用.png" width="1000"></div>  

从系统调用中可以看到，底层







